<!doctype html>
<html>
<head>
<title>Hex viewer</title>
<link rel="stylesheet" type="text/less" href="style.less">
<script src="less.js"></script>
</head>
<body>

<div id="hex-viewer"></div>

<p>
<label for="file-picker">Open file</label>
<input type="file" id="file-picker">

<script src="polyfill.js"></script>
<script src="annotations.js"></script>
<script src="hex-viewer.js"></script>
<script>
var hexViewer = new HexViewer('hex-viewer');
// end core, begin params
var testData = array_to_arraybuffer(function () {
    // fill array with 0x00 .. 0xff
    var a = [];
    for (var i = 0; i < 0x100; i++)
        a[i] = i;
    return a;
}());
//hexViewer.loadData(testData);
loadArrayBuffer('test.bin', hexViewer.loadData.bind(hexViewer));
loadString('test.txt', function (text) {
    var annots = Annotations.loadFieldsizeFormat(text);
    hexViewer.setAnnotations(annots);
});

hexViewer.handleFilePicker('file-picker');

function array_to_arraybuffer (arr) {
    var buffer = new ArrayBuffer(arr.length);
    var byteView = new Uint8Array(buffer);
    arr.forEach(function (b, i) {
        byteView[i] = b;
    });
    return buffer;
}

function loadString(url, callback) {
    var xhr = new XMLHttpRequest();
    xhr.open('get', url, true);
    xhr.onload = function () {
        if (xhr.responseText) {
            var len = xhr.responseText.length;
            if (len > 1024 * 1024 &&
                !confirm('Continue processing ' + len + ' chars?')) {
                console.log('Aborted processing of ' + url);
                return;
            }
            callback(xhr.responseText);
        } else {
            console.log('Cannot load text for ' + url);
        }
    };
    xhr.send(null);
}

function loadArrayBuffer(url, callback) {
    var xhr = new XMLHttpRequest();
    xhr.open('get', url, true);
    xhr.responseType = 'arraybuffer';
    xhr.onload = function () {
        if (xhr.response) {
            var len = xhr.response.byteLength;
            if (len > 1024 * 1024 &&
                !confirm('Continue processing ' + len + ' bytes?')) {
                console.log('Aborted processing of ' + url);
                return;
            }
            callback(xhr.response);
        } else {
            console.log('Cannot load ArrayBuffer for ' + url);
        }
    };
    xhr.send(null);
}
</script>
</body>
</html>
<!-- vim: set sw=4 et ts=4: -->
